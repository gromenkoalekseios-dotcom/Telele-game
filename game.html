<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>⚡ POWER CLICKER</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">

<style>
  :root {
    --bg: #050510;
    --accent: #00ffcc;
    --accent2: #ff00aa;
    --accent3: #ffee00;
  }
  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html,body { width:100%; height:100%; overflow:hidden; background:var(--bg); font-family:'Share Tech Mono',monospace; color:var(--accent); }
  body::before {
    content:''; position:fixed; inset:0;
    background-image: linear-gradient(rgba(0,255,204,0.03) 1px,transparent 1px), linear-gradient(90deg,rgba(0,255,204,0.03) 1px,transparent 1px);
    background-size:30px 30px; pointer-events:none; z-index:0;
  }
  .app { display:flex; flex-direction:column; height:100vh; height:100dvh; position:relative; z-index:1; }
  .header { display:flex; align-items:center; justify-content:space-between; padding:8px 14px 4px; flex-shrink:0; }
  .logo { font-family:'Orbitron',monospace; font-size:1rem; font-weight:900; letter-spacing:0.2em; color:var(--accent); text-shadow:0 0 15px #00ffcc88; }
  .save-dot { width:7px; height:7px; border-radius:50%; background:#00ffcc22; transition:background 0.4s,box-shadow 0.4s; }
  .save-dot.saving { background:var(--accent3); box-shadow:0 0 8px var(--accent3); }
  .save-dot.saved  { background:var(--accent);  box-shadow:0 0 8px var(--accent); }
  .save-dot.error  { background:var(--accent2); box-shadow:0 0 8px var(--accent2); }
  .center { display:flex; flex-direction:column; align-items:center; justify-content:center; flex-shrink:0; padding:6px 0 10px; gap:5px; }
  .score-label { font-size:0.52rem; letter-spacing:0.3em; color:#00ffcc33; }
  .score { font-family:'Orbitron',monospace; font-size:2.4rem; font-weight:900; color:var(--accent); text-shadow:0 0 25px #00ffcc99; line-height:1; transition:transform 0.05s; }
  .score.bump { transform:scale(1.06); }
  .per-sec { font-size:0.62rem; color:var(--accent2); text-shadow:0 0 8px var(--accent2); letter-spacing:0.1em; }
  .click-btn {
    width:130px; height:130px; border-radius:50%;
    border:2px solid var(--accent);
    background:radial-gradient(circle at 40% 35%,#001a14,#000508);
    cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:3.2rem;
    box-shadow:0 0 25px #00ffcc44,inset 0 0 25px #00ffcc0d;
    transition:transform 0.07s,box-shadow 0.07s; user-select:none; position:relative;
  }
  .click-btn::after { content:''; position:absolute; inset:-6px; border-radius:50%; border:1.5px solid var(--accent); opacity:0; animation:ring 3s ease-in-out infinite; }
  @keyframes ring { 0%,100%{opacity:0;transform:scale(1)} 50%{opacity:0.2;transform:scale(1.05)} }
  .click-btn:active { transform:scale(0.90); box-shadow:0 0 60px #00ffccaa,inset 0 0 30px #00ffcc22; }
  .click-info { font-size:0.56rem; color:#00ffcc33; letter-spacing:0.1em; }
  .tabs { display:flex; border-top:1px solid #00ffcc18; border-bottom:1px solid #00ffcc18; flex-shrink:0; }
  .tab { flex:1; background:none; border:none; color:#00ffcc44; font-family:'Orbitron',monospace; font-size:0.52rem; letter-spacing:0.1em; padding:8px 2px; cursor:pointer; transition:color 0.2s,background 0.2s; text-transform:uppercase; }
  .tab.active { color:var(--accent); background:#00ffcc0a; text-shadow:0 0 8px var(--accent); }
  .panels { flex:1; overflow:hidden; position:relative; }
  .panel { position:absolute; inset:0; overflow-y:auto; padding:8px 10px 16px; display:none; -webkit-overflow-scrolling:touch; }
  .panel.active { display:block; }
  .panel::-webkit-scrollbar { width:3px; }
  .panel::-webkit-scrollbar-thumb { background:#00ffcc22; border-radius:2px; }
  .item-btn {
    width:100%; background:#000; border:1px solid #00ffcc18; color:var(--accent);
    font-family:'Share Tech Mono',monospace; font-size:0.7rem; padding:10px 12px; margin-bottom:6px;
    cursor:pointer; display:flex; justify-content:space-between; align-items:center;
    transition:border-color 0.15s,background 0.15s; text-align:left; border-radius:2px;
  }
  .item-btn:active:not(.locked) { border-color:var(--accent); background:#00ffcc08; }
  .item-btn.locked { opacity:0.25; }
  .item-left { display:flex; flex-direction:column; gap:2px; }
  .item-name { color:var(--accent); font-size:0.7rem; }
  .item-desc { font-size:0.56rem; color:#00ffcc44; }
  .item-owned { font-size:0.54rem; color:var(--accent2); }
  .item-cost { color:var(--accent3); font-size:0.66rem; white-space:nowrap; padding-left:8px; }
  .prestige-wrap { margin-top:8px; }
  .prestige-btn {
    width:100%; background:linear-gradient(135deg,#1a0020,#0a000f);
    border:1px solid var(--accent2); color:var(--accent2); font-family:'Orbitron',monospace;
    font-size:0.58rem; letter-spacing:0.08em; padding:12px 8px; cursor:pointer;
    text-shadow:0 0 10px var(--accent2); box-shadow:0 0 12px #ff00aa18; transition:all 0.2s; border-radius:2px;
  }
  .prestige-btn:active:not([disabled]) { box-shadow:0 0 25px #ff00aa55; }
  .prestige-btn[disabled] { opacity:0.2; cursor:not-allowed; }
  .prestige-info { font-size:0.54rem; color:var(--accent2); text-align:center; margin-top:5px; line-height:1.7; }
  .stat-row { display:flex; justify-content:space-between; padding:9px 0; border-bottom:1px solid #00ffcc0a; font-size:0.66rem; }
  .stat-row:last-child { border-bottom:none; }
  .stat-label { color:#00ffcc44; }
  .stat-val { color:var(--accent); }
  .float-text { position:fixed; font-family:'Orbitron',monospace; font-weight:700; pointer-events:none; z-index:500; animation:floatUp 0.85s ease-out forwards; }
  @keyframes floatUp { 0%{opacity:1;transform:translateY(0) scale(1)} 100%{opacity:0;transform:translateY(-65px) scale(0.5)} }
  .notif { position:fixed; bottom:16px; left:50%; transform:translateX(-50%); background:#0a0a1f; border:1px solid var(--accent3); color:var(--accent3); font-family:'Share Tech Mono',monospace; font-size:0.62rem; padding:7px 16px; z-index:200; animation:notifAnim 2s ease forwards; white-space:nowrap; border-radius:2px; }
  @keyframes notifAnim { 0%{opacity:0;bottom:4px} 15%{opacity:1;bottom:16px} 75%{opacity:1;bottom:16px} 100%{opacity:0;bottom:4px} }
  #loading-screen { position:fixed; inset:0; background:var(--bg); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:1000; gap:14px; }
  .loading-text { font-family:'Orbitron',monospace; font-size:0.7rem; letter-spacing:0.25em; color:var(--accent); animation:blink 1s ease-in-out infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.25} }
</style>
</head>
<body>

<div id="loading-screen">
  <div style="font-size:2.5rem">⚡</div>
  <div class="loading-text">ЗАГРУЗКА...</div>
</div>

<div class="app">
  <div class="header">
    <div class="logo">⚡ POWER CLICKER</div>
    <div class="save-dot" id="save-dot"></div>
  </div>

  <div class="center">
    <div class="score-label">ЭНЕРГИЯ</div>
    <div class="score" id="score">0</div>
    <div class="per-sec" id="per-sec">+0 / сек</div>
    <button class="click-btn" id="click-btn">⚡</button>
    <div class="click-info" id="click-info">за клик: +1</div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="upgrades">▸ УЛУЧШЕНИЯ</button>
    <button class="tab" data-tab="generators">◈ ГЕНЕРАТОРЫ</button>
    <button class="tab" data-tab="stats">≡ СТАТИСТИКА</button>
  </div>

  <div class="panels">
    <div class="panel active" id="panel-upgrades"></div>
    <div class="panel" id="panel-generators"></div>
    <div class="panel" id="panel-stats"></div>
  </div>
</div>

<script>
// ────────────────────────────────────────────────────────────────
// Основные переменные
// ────────────────────────────────────────────────────────────────
const tg = window.Telegram?.WebApp || {};
tg.ready?.();
tg.expand?.();
tg.disableVerticalSwipes?.();

const SAVE_KEY = 'power_clicker_v2026_3';

let score = 0;
let totalClicks = 0;
let totalEarned = 0;
let prestigeCount = 0;
let prestigeMulti = 1;
let uOwned = [0,0,0,0,0];
let gOwned = [0,0,0,0,0];

const BASE_UPGRADES = [
  {name:'Усилитель',   desc:'+1 за клик',   cost:50,    bonus:1},
  {name:'Суперзаряд',  desc:'+5 за клик',   cost:300,   bonus:5},
  {name:'Молния',      desc:'+20 за клик',  cost:2000,  bonus:20},
  {name:'Плазма',      desc:'+100 за клик', cost:15000, bonus:100},
  {name:'Антиматерия', desc:'+500 за клик', cost:100000,bonus:500}
];

const BASE_GENERATORS = [
  {name:'Батарейка',        desc:'+1/сек',    cost:100,   perSec:1},
  {name:'Солнечная панель', desc:'+5/сек',    cost:500,   perSec:5},
  {name:'Реактор',          desc:'+25/сек',   cost:3000,  perSec:25},
  {name:'Термоядерный',     desc:'+150/сек',  cost:20000, perSec:150},
  {name:'Тёмная энергия',   desc:'+1000/сек', cost:150000,perSec:1000}
];

const U_MULT = 2.2;
const G_MULT = 1.8;

// ────────────────────────────────────────────────────────────────
// Вспомогательные функции
// ────────────────────────────────────────────────────────────────
function fmt(n) {
  if (n >= 1e9) return (n/1e9).toFixed(2)+'B';
  if (n >= 1e6) return (n/1e6).toFixed(2)+'M';
  if (n >= 1e3) return (n/1e3).toFixed(1)+'K';
  return n.toString();
}

function calcCost(base, owned, mult) {
  let c = base;
  for (let i = 0; i < owned; i++) c = Math.floor(c * mult);
  return c;
}

function getClickPower() {
  let b = 0;
  for (let i = 0; i < 5; i++) b += BASE_UPGRADES[i].bonus * uOwned[i];
  return Math.max(1, Math.floor((1 + b) * prestigeMulti));
}

function getPerSec() {
  let ps = 0;
  for (let i = 0; i < 5; i++) ps += BASE_GENERATORS[i].perSec * gOwned[i];
  return Math.floor(ps * prestigeMulti);
}

// ────────────────────────────────────────────────────────────────
// Сохранение / загрузка — DeviceStorage → CloudStorage → localStorage
// ────────────────────────────────────────────────────────────────
function getStorage() {
  if (tg.DeviceStorage)  return {type: 'Device',  obj: tg.DeviceStorage};
  if (tg.CloudStorage)   return {type: 'Cloud',   obj: tg.CloudStorage};
  return {type: 'local', obj: null};
}

const storage = getStorage();
let saveInProgress = false;

function doSave() {
  if (saveInProgress) return;
  saveInProgress = true;

  const data = JSON.stringify({
    v: 2026_3,
    s: score,
    tc: totalClicks,
    te: totalEarned,
    pc: prestigeCount,
    pm: prestigeMulti,
    uo: uOwned,
    go: gOwned
  });

  const dot = document.getElementById('save-dot');
  dot.className = 'save-dot saving';

  function finish(cls) {
    dot.className = 'save-dot ' + cls;
    setTimeout(() => dot.className = 'save-dot', 1800);
    saveInProgress = false;
  }

  if (storage.type !== 'local') {
    storage.obj.setItem(SAVE_KEY, data, err => {
      if (err) {
        console.warn(storage.type + ' save failed', err);
        try { localStorage.setItem(SAVE_KEY, data); } catch(e){}
        finish('error');
      } else {
        finish('saved');
      }
    });
  } else {
    try {
      localStorage.setItem(SAVE_KEY, data);
      finish('saved');
    } catch (e) {
      finish('error');
    }
  }
}

function loadSave(callback) {
  function apply(raw) {
    try {
      const d = JSON.parse(raw);
      if (d.v !== 2026_3) return;
      score         = d.s  || 0;
      totalClicks   = d.tc || 0;
      totalEarned   = d.te || 0;
      prestigeCount = d.pc || 0;
      prestigeMulti = d.pm || 1;
      uOwned        = Array.isArray(d.uo) ? d.uo.map(Number) : [0,0,0,0,0];
      gOwned        = Array.isArray(d.go) ? d.go.map(Number) : [0,0,0,0,0];
    } catch (e) {}
  }

  if (storage.type !== 'local') {
    storage.obj.getItem(SAVE_KEY, (err, val) => {
      if (!err && val) apply(val);
      else {
        const loc = localStorage.getItem(SAVE_KEY);
        if (loc) apply(loc);
      }
      callback();
    });
  } else {
    const loc = localStorage.getItem(SAVE_KEY);
    if (loc) apply(loc);
    callback();
  }
}

// ────────────────────────────────────────────────────────────────
// Игровая логика
// ────────────────────────────────────────────────────────────────
function handleClick(e) {
  const power = getClickPower();
  score += power;
  totalClicks++;
  totalEarned += power;

  const fl = document.createElement('div');
  fl.className = 'float-text';
  fl.textContent = '+' + fmt(power);
  fl.style.left = e.clientX - 20 + 'px';
  fl.style.top  = e.clientY - 20 + 'px';
  fl.style.color = Math.random() > 0.5 ? '#00ffcc' : '#ffee00';
  document.body.appendChild(fl);
  setTimeout(() => fl.remove(), 900);

  const btn = document.getElement
